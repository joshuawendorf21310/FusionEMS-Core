name: Deploy Backend

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment (dev/prod)'
        required: true
        default: dev
        type: choice
        options: [dev, prod]
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'opa/**'

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-backend-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx
      - name: Run tests
        run: |
          cd backend
          python -m pytest tests/ -v --tb=short

  build-push:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      ecr_repo: ${{ steps.ecr.outputs.registry }}
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      CFN_STACK_NAME: ${{ vars.CFN_STACK_NAME }}
      CFN_ENV: ${{ inputs.env || vars.CFN_ENV }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image metadata
        id: meta
        run: |
          IMAGE_TAG="${GITHUB_SHA}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          ECR_REPO=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='BackendEcrRepoUri'].OutputValue" \
            --output text)
          echo "ecr_repo=${ECR_REPO}" >> $GITHUB_OUTPUT

      - name: Build and push backend image
        run: |
          set -euo pipefail
          IMAGE="${{ steps.meta.outputs.ecr_repo }}:${{ steps.meta.outputs.image_tag }}"
          docker build \
            --file backend/core_app/Dockerfile \
            --tag "$IMAGE" \
            --tag "${{ steps.meta.outputs.ecr_repo }}:latest" \
            --build-arg BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --build-arg GIT_SHA="${GITHUB_SHA}" \
            backend/
          docker push "$IMAGE"
          docker push "${{ steps.meta.outputs.ecr_repo }}:latest"
          echo "Pushed: $IMAGE"

  migrate:
    needs: build-push
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      CFN_STACK_NAME: ${{ vars.CFN_STACK_NAME }}
      CFN_ENV: ${{ inputs.env || vars.CFN_ENV }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run database migrations (ECS one-off task)
        run: |
          set -euo pipefail

          CLUSTER=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='ClusterName'].OutputValue" \
            --output text 2>/dev/null || echo "")

          TASK_DEF=$(aws ecs list-task-definitions \
            --family-prefix "fusionems-quantum-${CFN_ENV}-backend" \
            --sort DESC \
            --query 'taskDefinitionArns[0]' \
            --output text)

          PRIVATE_SUBNETS=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query "Stacks[0].Outputs[?contains(OutputKey,'PrivateSubnets')].OutputValue" \
            --output text 2>/dev/null || echo "")

          ECS_SG=$(aws ec2 describe-security-groups \
            --filters "Name=tag:Name,Values=fusionems-quantum-${CFN_ENV}-sg-ecs" \
            --query 'SecurityGroups[0].GroupId' \
            --output text)

          if [ -z "$CLUSTER" ] || [ "$CLUSTER" = "None" ]; then
            echo "Cluster not found, skipping migration (first deploy)"
            exit 0
          fi

          TASK_ARN=$(aws ecs run-task \
            --cluster "$CLUSTER" \
            --task-definition "$TASK_DEF" \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${PRIVATE_SUBNETS//,/,}],securityGroups=[$ECS_SG],assignPublicIp=DISABLED}" \
            --overrides '{"containerOverrides":[{"name":"backend","command":["python","-m","alembic","upgrade","head"]}]}' \
            --query 'tasks[0].taskArn' \
            --output text)

          echo "Migration task ARN: $TASK_ARN"

          aws ecs wait tasks-stopped \
            --cluster "$CLUSTER" \
            --tasks "$TASK_ARN" \
            --cli-read-timeout 300

          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster "$CLUSTER" \
            --tasks "$TASK_ARN" \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          echo "Migration exit code: $EXIT_CODE"
          [ "$EXIT_CODE" = "0" ] || (echo "Migration failed with exit code $EXIT_CODE" && exit 1)

  deploy-service:
    needs: migrate
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      CFN_STACK_NAME: ${{ vars.CFN_STACK_NAME }}
      CFN_ENV: ${{ inputs.env || vars.CFN_ENV }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update ECS backend service with new image
        run: |
          set -euo pipefail

          CLUSTER=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='ClusterName'].OutputValue" \
            --output text)

          BACKEND_SERVICE=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='BackendServiceName'].OutputValue" \
            --output text)

          aws ecs update-service \
            --cluster "$CLUSTER" \
            --service "$BACKEND_SERVICE" \
            --force-new-deployment \
            --no-cli-pager

          echo "Waiting for backend service to stabilize..."
          aws ecs wait services-stable \
            --cluster "$CLUSTER" \
            --services "$BACKEND_SERVICE"

          echo "Backend deployed successfully."

      - name: Smoke test
        run: |
          set -euo pipefail
          API_URL="https://${{ vars.CFN_API_DOMAIN_NAME }}"
          for i in {1..30}; do
            if curl -fsS "${API_URL}/api/v1/health" >/dev/null 2>&1; then
              echo "API healthy"
              exit 0
            fi
            echo "Retry $i/30..."
            sleep 10
          done
          echo "API health check failed after 30 retries"
          exit 1
