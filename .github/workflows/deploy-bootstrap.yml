name: Deploy Bootstrap (Seed Catalogs + Stripe + Integrations)

on:
  workflow_call:
    inputs:
      env:
        description: 'Environment (dev/prod)'
        required: true
        type: string
      seed_stripe:
        description: 'Sync Stripe products/prices'
        type: boolean
        default: true
      seed_nemsis:
        description: 'Seed NEMSIS value sets'
        type: boolean
        default: true
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment (dev/prod)'
        required: true
        default: dev
        type: choice
        options: [dev, prod]
      seed_stripe:
        description: 'Sync Stripe products/prices'
        type: boolean
        default: true
      seed_nemsis:
        description: 'Seed NEMSIS value sets'
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read

jobs:
  bootstrap:
    runs-on: ubuntu-24.04
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      CFN_STACK_NAME: ${{ vars.CFN_STACK_NAME }}
      CFN_ENV: ${{ inputs.env || vars.CFN_ENV }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install bootstrap dependencies
        run: |
          pip install boto3 requests stripe python-dotenv

      - name: Fetch app secrets from Secrets Manager
        run: |
          set -euo pipefail
          APP_SECRETS_ARN=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='AppSecretsArn'].OutputValue" \
            --output text 2>/dev/null || echo "")
          if [ -n "$APP_SECRETS_ARN" ] && [ "$APP_SECRETS_ARN" != "None" ]; then
            aws secretsmanager get-secret-value \
              --secret-id "$APP_SECRETS_ARN" \
              --query 'SecretString' \
              --output text > /tmp/app_secrets.json
            echo "APP_SECRETS loaded"
          fi

      - name: Sync Stripe products and prices
        if: ${{ inputs.seed_stripe }}
        run: |
          python - <<'EOF'
          import json, os, sys
          try:
              import stripe
              with open('/tmp/app_secrets.json') as f:
                  secrets = json.load(f)
              stripe.api_key = secrets.get('stripe_secret_key', '')
              if not stripe.api_key or stripe.api_key.startswith('REPLACE'):
                  print("Stripe key not configured, skipping")
                  sys.exit(0)
              products = [
                  {'name': 'FusionEMS Base Platform', 'metadata': {'type': 'base'}},
                  {'name': 'FusionEMS Per-Transport Fee', 'metadata': {'type': 'per_call'}},
                  {'name': 'FusionEMS Overlay Mode', 'metadata': {'type': 'overlay'}},
              ]
              for p in products:
                  existing = stripe.Product.list(active=True)
                  names = [e['name'] for e in existing['data']]
                  if p['name'] not in names:
                      prod = stripe.Product.create(name=p['name'], metadata=p['metadata'])
                      print(f"Created product: {prod['id']} - {p['name']}")
                  else:
                      print(f"Product exists: {p['name']}")
          except Exception as e:
              print(f"Stripe sync error: {e}")
          EOF

      - name: Seed NEMSIS value sets
        if: ${{ inputs.seed_nemsis }}
        run: |
          echo "NEMSIS value set seeding - placeholder for actual NEMSIS data import"
          echo "Run: python backend/scripts/seed_nemsis_valuesets.py"

      - name: Run DB seed via ECS task
        run: |
          set -euo pipefail
          CLUSTER=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='ClusterName'].OutputValue" \
            --output text 2>/dev/null || echo "")
          if [ -z "$CLUSTER" ] || [ "$CLUSTER" = "None" ]; then
            echo "Cluster not deployed yet, skipping ECS seed"
            exit 0
          fi
          echo "Bootstrap complete. Run tenant setup via /api/v1/onboarding/provision"
