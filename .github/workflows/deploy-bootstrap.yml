name: Deploy Bootstrap (Elite)

on:
  workflow_call:
    inputs:
      env:
        required: true
        type: string
      seed_stripe:
        type: boolean
        default: true
      seed_nemsis:
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read

concurrency:
  group: bootstrap-${{ inputs.env }}
  cancel-in-progress: false

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      CFN_STACK_NAME: ${{ vars.CFN_STACK_NAME }}

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      # ==========================================
      # RESOLVE STACK OUTPUTS (NO GUESSING)
      # ==========================================
      - name: Resolve infrastructure outputs
        id: infra
        run: |
          set -euo pipefail

          get_output () {
            aws cloudformation describe-stacks \
              --stack-name "$CFN_STACK_NAME" \
              --query "Stacks[0].Outputs[?OutputKey=='$1'].OutputValue" \
              --output text
          }

          echo "cluster=$(get_output ClusterName)" >> $GITHUB_OUTPUT
          echo "task_def=$(get_output BackendTaskDefinitionArn)" >> $GITHUB_OUTPUT
          echo "subnets=$(get_output PrivateSubnetIds)" >> $GITHUB_OUTPUT
          echo "sg=$(get_output EcsSecurityGroupId)" >> $GITHUB_OUTPUT

      # ==========================================
      # STRIPE SYNC (IN CONTAINER)
      # ==========================================
      - name: Stripe sync via ECS
        if: ${{ inputs.seed_stripe }}
        run: |
          set -euo pipefail

          TASK_ARN=$(aws ecs run-task \
            --cluster "${{ steps.infra.outputs.cluster }}" \
            --task-definition "${{ steps.infra.outputs.task_def }}" \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ steps.infra.outputs.subnets }}],securityGroups=[${{ steps.infra.outputs.sg }}],assignPublicIp=DISABLED}" \
            --overrides '{"containerOverrides":[{"name":"backend","command":["python","-m","backend.scripts.sync_stripe"]}]}' \
            --query 'tasks[0].taskArn' \
            --output text)

          aws ecs wait tasks-stopped \
            --cluster "${{ steps.infra.outputs.cluster }}" \
            --tasks "$TASK_ARN"

          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster "${{ steps.infra.outputs.cluster }}" \
            --tasks "$TASK_ARN" \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          [ "$EXIT_CODE" = "0" ] || exit 1

      # ==========================================
      # NEMSIS SEED (IN CONTAINER)
      # ==========================================
      - name: NEMSIS seed via ECS
        if: ${{ inputs.seed_nemsis }}
        run: |
          set -euo pipefail

          TASK_ARN=$(aws ecs run-task \
            --cluster "${{ steps.infra.outputs.cluster }}" \
            --task-definition "${{ steps.infra.outputs.task_def }}" \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ steps.infra.outputs.subnets }}],securityGroups=[${{ steps.infra.outputs.sg }}],assignPublicIp=DISABLED}" \
            --overrides '{"containerOverrides":[{"name":"backend","command":["python","-m","backend.scripts.seed_nemsis_valuesets"]}]}' \
            --query 'tasks[0].taskArn' \
            --output text)

          aws ecs wait tasks-stopped \
            --cluster "${{ steps.infra.outputs.cluster }}" \
            --tasks "$TASK_ARN"

          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster "${{ steps.infra.outputs.cluster }}" \
            --tasks "$TASK_ARN" \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          [ "$EXIT_CODE" = "0" ] || exit 1

      # ==========================================
      # DATABASE SEED (IN CONTAINER)
      # ==========================================
      - name: Database seed via ECS
        run: |
          set -euo pipefail

          TASK_ARN=$(aws ecs run-task \
            --cluster "${{ steps.infra.outputs.cluster }}" \
            --task-definition "${{ steps.infra.outputs.task_def }}" \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ steps.infra.outputs.subnets }}],securityGroups=[${{ steps.infra.outputs.sg }}],assignPublicIp=DISABLED}" \
            --overrides '{"containerOverrides":[{"name":"backend","command":["python","-m","backend.scripts.seed_database"]}]}' \
            --query 'tasks[0].taskArn' \
            --output text)

          aws ecs wait tasks-stopped \
            --cluster "${{ steps.infra.outputs.cluster }}" \
            --tasks "$TASK_ARN"

          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster "${{ steps.infra.outputs.cluster }}" \
            --tasks "$TASK_ARN" \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          [ "$EXIT_CODE" = "0" ] || exit 1
