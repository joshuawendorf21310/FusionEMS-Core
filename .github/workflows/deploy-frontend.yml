name: Deploy Frontend

on:
  workflow_call:
    inputs:
      env:
        description: 'Environment (dev/prod)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      env:
        description: 'Environment (dev/prod)'
        required: true
        default: dev
        type: choice
        options: [dev, prod]
  push:
    branches: [main]
    paths:
      - 'frontend/**'

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-frontend-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-push:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      CFN_STACK_NAME: ${{ vars.CFN_STACK_NAME }}
      CFN_ENV: ${{ inputs.env || vars.CFN_ENV }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get ECR repo URI
        id: repo
        run: |
          REPO=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='FrontendEcrRepoUri'].OutputValue" \
            --output text)
          echo "ecr_repo=${REPO}" >> $GITHUB_OUTPUT

      - name: Build and push frontend image
        run: |
          set -euo pipefail
          IMAGE="${{ steps.repo.outputs.ecr_repo }}:${GITHUB_SHA}"
          API_DOMAIN=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='ApiDomainName'].OutputValue" \
            --output text 2>/dev/null || echo "${{ vars.CFN_API_DOMAIN_NAME }}")
          ROOT_DOMAIN=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='RootDomainName'].OutputValue" \
            --output text 2>/dev/null || echo "${{ vars.CFN_ROOT_DOMAIN_NAME }}")
          docker build \
            --file frontend/Dockerfile \
            --tag "$IMAGE" \
            --tag "${{ steps.repo.outputs.ecr_repo }}:latest" \
            --build-arg NEXT_PUBLIC_API_BASE="https://${API_DOMAIN}" \
            --build-arg NEXT_PUBLIC_WS_URL="wss://${API_DOMAIN}/ws" \
            --build-arg NEXT_PUBLIC_ROOT_DOMAIN="https://${ROOT_DOMAIN}" \
            frontend/
          docker push "$IMAGE"
          docker push "${{ steps.repo.outputs.ecr_repo }}:latest"

  deploy-service:
    needs: build-push
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      CFN_STACK_NAME: ${{ vars.CFN_STACK_NAME }}
      CFN_ENV: ${{ inputs.env || vars.CFN_ENV }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update ECS frontend service
        run: |
          set -euo pipefail
          CLUSTER=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='ClusterName'].OutputValue" \
            --output text)
          FRONTEND_SERVICE=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query "Stacks[0].Outputs[?OutputKey=='FrontendServiceName'].OutputValue" \
            --output text)
          aws ecs update-service \
            --cluster "$CLUSTER" \
            --service "$FRONTEND_SERVICE" \
            --force-new-deployment \
            --no-cli-pager
          aws ecs wait services-stable \
            --cluster "$CLUSTER" \
            --services "$FRONTEND_SERVICE"
          echo "Frontend deployed."

      - name: Smoke test
        run: |
          for i in {1..20}; do
            if curl -fsS "https://${{ vars.CFN_ROOT_DOMAIN_NAME }}/healthz" >/dev/null 2>&1; then
              echo "Frontend healthy"
              exit 0
            fi
            echo "Retry $i/20..."
            sleep 10
          done
          exit 1
