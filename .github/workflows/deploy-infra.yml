name: Deploy Infrastructure

on:
  workflow_call:
    inputs:
      env:
        description: "Environment (dev/prod)"
        required: true
        type: string
  workflow_dispatch:
    inputs:
      env:
        description: "Environment (dev/prod)"
        required: true
        default: dev
        type: choice
        options: [dev, prod]
  push:
    branches: [main]
    paths:
      - "infra/**"

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-infra-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-infra:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      CFN_STACK_NAME: ${{ vars.CFN_STACK_NAME }}
      CFN_ENV: ${{ inputs.env || vars.CFN_ENV }}
      CFN_ROOT_DOMAIN_NAME: ${{ vars.CFN_ROOT_DOMAIN_NAME }}
      CFN_API_DOMAIN_NAME: ${{ vars.CFN_API_DOMAIN_NAME }}
      CFN_HOSTED_ZONE_ID: ${{ vars.CFN_HOSTED_ZONE_ID }}
      CFN_ARTIFACTS_BUCKET: ${{ vars.CFN_ARTIFACTS_BUCKET }}
      CFN_ALERT_EMAIL: ${{ vars.CFN_ALERT_EMAIL }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Resolve and validate environment
        id: resolve-env
        run: |
          set -euo pipefail
          if [[ "${CFN_STACK_NAME}" == *-prod* ]]; then
            DERIVED_ENV=prod
          else
            DERIVED_ENV=dev
          fi
          EFFECTIVE_ENV="${CFN_ENV:-$DERIVED_ENV}"
          if [[ "${CFN_STACK_NAME}" == *-prod* && "$EFFECTIVE_ENV" != "prod" ]]; then
            echo "Auto-correcting: stack name contains 'prod', overriding CFN_ENV from '$EFFECTIVE_ENV' to 'prod'"
            EFFECTIVE_ENV=prod
          fi
          echo "CFN_ENV=$EFFECTIVE_ENV" >> "$GITHUB_ENV"
          echo "Effective environment: $EFFECTIVE_ENV"
          if [[ -z "${CFN_HOSTED_ZONE_ID}" ]]; then echo "CFN_HOSTED_ZONE_ID is required"; exit 1; fi
          if [[ -z "${CFN_ARTIFACTS_BUCKET}" ]]; then echo "CFN_ARTIFACTS_BUCKET is required"; exit 1; fi

      - name: Validate all CloudFormation templates
        run: |
          set -euo pipefail
          for template in infra/cloudformation/*.yml; do
            echo "Validating $template..."
            aws cloudformation validate-template --template-body "file://$template"
          done
          echo "All templates valid."

      - name: Package CloudFormation
        run: |
          set -euo pipefail
          aws cloudformation package \
            --template-file infra/cloudformation/root.yml \
            --s3-bucket "$CFN_ARTIFACTS_BUCKET" \
            --s3-prefix "cfn/$(date +%Y%m%d)-${GITHUB_SHA:0:8}" \
            --output-template-file packaged.root.yml

      - name: Clean up broken stack if needed
        run: |
          set -euo pipefail

          delete_stack_hard() {
            echo "Deleting stack (normal)..."
            aws cloudformation delete-stack --stack-name "${CFN_STACK_NAME}" || true

            if ! aws cloudformation wait stack-delete-complete --stack-name "${CFN_STACK_NAME}" --cli-read-timeout 600; then
              STATUS2=$(aws cloudformation describe-stacks \
                --stack-name "${CFN_STACK_NAME}" \
                --query 'Stacks[0].StackStatus' \
                --output text 2>/dev/null || echo "DOES_NOT_EXIST")
              echo "Delete wait failed. Current status: $STATUS2"

              if [[ "$STATUS2" == "DELETE_FAILED" ]]; then
                echo "Stack is DELETE_FAILED — retrying with FORCE_DELETE_STACK..."
                aws cloudformation delete-stack \
                  --stack-name "${CFN_STACK_NAME}" \
                  --deletion-mode FORCE_DELETE_STACK

                aws cloudformation wait stack-delete-complete \
                  --stack-name "${CFN_STACK_NAME}" \
                  --cli-read-timeout 900 || true
              fi
            fi

            FINAL=$(aws cloudformation describe-stacks \
              --stack-name "${CFN_STACK_NAME}" \
              --query 'Stacks[0].StackStatus' \
              --output text 2>/dev/null || echo "DOES_NOT_EXIST")
            echo "Final stack status after delete attempts: $FINAL"

            if [[ "$FINAL" != "DOES_NOT_EXIST" ]]; then
              echo "Stack was not deleted successfully (status=$FINAL). Failing fast."
              exit 1
            fi

            echo "Stack fully deleted."
          }

          STATUS=$(aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "DOES_NOT_EXIST")
          echo "Current stack status: $STATUS"

          case "$STATUS" in
            DOES_NOT_EXIST)
              echo "Stack does not exist. Proceeding."
              ;;
            ROLLBACK_COMPLETE|ROLLBACK_FAILED|CREATE_FAILED|UPDATE_ROLLBACK_FAILED|UPDATE_ROLLBACK_COMPLETE|IMPORT_ROLLBACK_FAILED|DELETE_FAILED)
              echo "Stack is $STATUS — deleting before redeploy..."
              aws cloudformation continue-update-rollback --stack-name "${CFN_STACK_NAME}" 2>/dev/null || true
              delete_stack_hard
              ;;
            *)
              echo "Stack is in $STATUS — not auto-deleting."
              ;;
          esac

      - name: Deploy infrastructure stack
        run: |
          set -euo pipefail
          aws cloudformation deploy \
            --stack-name "${CFN_STACK_NAME}" \
            --template-file packaged.root.yml \
            --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              Env="${CFN_ENV}" \
              RootDomainName="${CFN_ROOT_DOMAIN_NAME}" \
              ApiDomainName="${CFN_API_DOMAIN_NAME}" \
              HostedZoneId="${CFN_HOSTED_ZONE_ID}" \
              AlertEmail="${CFN_ALERT_EMAIL:-founder@fusionemsquantum.com}" \
              ImageTag="${GITHUB_SHA}" \
              NestedTemplatesBucket="${CFN_ARTIFACTS_BUCKET}" \
            --tags \
              Environment="${CFN_ENV}" \
              GitSha="${GITHUB_SHA}" \
              DeployedAt="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Dump stack events on failure
        if: failure()
        run: |
          aws cloudformation describe-stack-events \
            --stack-name "${CFN_STACK_NAME}" \
            --max-items 50 \
            --query 'StackEvents[?ResourceStatus==`CREATE_FAILED`||ResourceStatus==`UPDATE_FAILED`||ResourceStatus==`DELETE_FAILED`].[LogicalResourceId,ResourceStatus,ResourceStatusReason]' \
            --output table || true

      - name: Output stack results
        if: success()
        run: |
          aws cloudformation describe-stacks \
            --stack-name "${CFN_STACK_NAME}" \
            --query 'Stacks[0].Outputs' \
            --output table
