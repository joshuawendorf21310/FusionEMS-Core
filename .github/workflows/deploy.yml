name: Deploy Production (Stable)

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  STACK_NAME: fusionems-core
  ARTIFACT_BUCKET: fusionemsquantum-cfn-artifacts-prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────
      # Checkout
      # ─────────────────────────────────────────────
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ─────────────────────────────────────────────
      # Configure AWS OIDC
      # ─────────────────────────────────────────────
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::793439286972:role/fusionems-github-deploy-role
          aws-region: ${{ env.AWS_REGION }}

      # ─────────────────────────────────────────────
      # Install SAM CLI
      # ─────────────────────────────────────────────
      - name: Install AWS SAM CLI
        run: |
          pip install aws-sam-cli

      # ─────────────────────────────────────────────
      # Delete broken stack if stuck
      # ─────────────────────────────────────────────
      - name: Clean Previous Failed Stack
        run: |
          set -e
          STATUS=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --region $AWS_REGION \
            --query "Stacks[0].StackStatus" \
            --output text 2>/dev/null || echo "NONE")

          echo "Current stack status: $STATUS"

          if [[ "$STATUS" == "ROLLBACK_COMPLETE" || "$STATUS" == "CREATE_FAILED" ]]; then
            echo "Deleting failed stack..."
            aws cloudformation delete-stack \
              --stack-name $STACK_NAME \
              --region $AWS_REGION

            aws cloudformation wait stack-delete-complete \
              --stack-name $STACK_NAME \
              --region $AWS_REGION

            echo "Old stack deleted."
          fi

      # ─────────────────────────────────────────────
      # Build (handles nested stacks)
      # ─────────────────────────────────────────────
      - name: SAM Build
        run: |
          sam build \
            --template-file infra/cloudformation/root.yml

      # ─────────────────────────────────────────────
      # Deploy
      # ─────────────────────────────────────────────
      - name: SAM Deploy
        run: |
          sam deploy \
            --stack-name $STACK_NAME \
            --region $AWS_REGION \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
            --s3-bucket $ARTIFACT_BUCKET \
            --no-confirm-changeset \
            --parameter-overrides \
              Env=prod \
              NestedTemplatesBucket=$ARTIFACT_BUCKET \
              ImageTagFrontend=latest \
              ImageTagBackend=latest

      # ─────────────────────────────────────────────
      # Live Stack Event Streaming
      # ─────────────────────────────────────────────
      - name: Show Live Stack Events
        if: always()
        run: |
          echo "===================================================="
          echo "LIVE STACK EVENTS"
          echo "===================================================="

          aws cloudformation describe-stack-events \
            --stack-name $STACK_NAME \
            --region $AWS_REGION \
            --max-items 50 \
            --output table || true

      # ─────────────────────────────────────────────
      # Diagnostics on Failure
      # ─────────────────────────────────────────────
      - name: Failure Diagnostics
        if: failure()
        run: |
          echo "===================================================="
          echo "FAILURE DIAGNOSTICS"
          echo "===================================================="

          echo "Stack Status:"
          aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --region $AWS_REGION \
            --query "Stacks[0].StackStatus" \
            --output text || true

          echo "Recent Events:"
          aws cloudformation describe-stack-events \
            --stack-name $STACK_NAME \
            --region $AWS_REGION \
            --max-items 40 \
            --output table || true
