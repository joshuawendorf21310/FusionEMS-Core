name: FusionEMS Quantum â€“ Full Production Deploy

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment"
        required: true
        default: prod
        type: choice
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read

concurrency:
  group: fusionems-${{ inputs.env }}
  cancel-in-progress: false

env:
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:

  # ==========================================================
  # Configure AWS (OIDC)
  # ==========================================================

  deploy:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      # ==========================================================
      # Package Nested Templates
      # ==========================================================

      - name: Package CloudFormation
        run: |
          aws cloudformation package \
            --template-file infra/cloudformation/root.yml \
            --s3-bucket ${{ vars.CFN_ARTIFACTS_BUCKET }} \
            --output-template-file packaged.yml

      # ==========================================================
      # Deploy Root Stack
      # ==========================================================

      - name: Deploy Root Stack
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: ${{ vars.CFN_STACK_NAME }}
          template: packaged.yml
          capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
          no-fail-on-empty-changeset: "1"
          parameter-overrides: |
            Env=${{ inputs.env }}
            AppName=fusionems-quantum
            RootDomainName=${{ vars.CFN_ROOT_DOMAIN_NAME }}
            ApiDomainName=${{ vars.CFN_API_DOMAIN_NAME }}
            HostedZoneId=${{ vars.CFN_HOSTED_ZONE_ID }}
            NestedTemplatesBucket=${{ vars.CFN_ARTIFACTS_BUCKET }}
            ImageTagFrontend=${{ github.sha }}
            ImageTagBackend=${{ github.sha }}

      # ==========================================================
      # Output Stack Info
      # ==========================================================

      - name: Show Stack Outputs
        run: |
          aws cloudformation describe-stacks \
            --stack-name ${{ vars.CFN_STACK_NAME }} \
            --query "Stacks[0].Outputs" \
            --output table
