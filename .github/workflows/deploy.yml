name: CloudFormation - (Deploy)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      CFN_STACK_NAME: ${{ vars.CFN_STACK_NAME }}
      CFN_ENV: ${{ vars.CFN_ENV }}
      CFN_ROOT_DOMAIN_NAME: ${{ vars.CFN_ROOT_DOMAIN_NAME }}
      CFN_API_DOMAIN_NAME: ${{ vars.CFN_API_DOMAIN_NAME }}
      CFN_HOSTED_ZONE_ID: ${{ vars.CFN_HOSTED_ZONE_ID }}
      CFN_ACM_CERT_ARN_US_EAST_1: ${{ vars.CFN_ACM_CERT_ARN_US_EAST_1 }}
      CFN_ARTIFACTS_BUCKET: ${{ vars.CFN_ARTIFACTS_BUCKET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify required env vars
        run: |
          set -euo pipefail
          for v in AWS_REGION CFN_STACK_NAME CFN_ENV CFN_ROOT_DOMAIN_NAME CFN_API_DOMAIN_NAME CFN_HOSTED_ZONE_ID CFN_ACM_CERT_ARN_US_EAST_1 CFN_ARTIFACTS_BUCKET; do
            if [ -z "${!v:-}" ]; then
              echo "Missing required variable: $v"
              exit 1
            fi
          done
          echo "All required variables present."

      - name: Ensure artifacts bucket exists
        run: |
          set -euo pipefail
          aws s3api head-bucket --bucket "$CFN_ARTIFACTS_BUCKET"

      - name: CloudFormation validate templates
        run: |
          set -euo pipefail
          aws cloudformation validate-template --template-body file://infra/cloudformation/root.yml

      - name: Package CloudFormation (uploads nested templates to S3)
        run: |
          set -euo pipefail
          aws cloudformation package \
            --template-file infra/cloudformation/root.yml \
            --s3-bucket "$CFN_ARTIFACTS_BUCKET" \
            --output-template-file packaged.root.yml

      - name: Deploy CloudFormation stack
        run: |
          set -euo pipefail
          aws cloudformation deploy \
            --stack-name "$CFN_STACK_NAME" \
            --template-file packaged.root.yml \
            --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              Env="$CFN_ENV" \
              RootDomainName="$CFN_ROOT_DOMAIN_NAME" \
              ApiDomainName="$CFN_API_DOMAIN_NAME" \
              HostedZoneId="$CFN_HOSTED_ZONE_ID" \
              AcmCertificateArnUsEast1="$CFN_ACM_CERT_ARN_US_EAST_1" \
              ImageTag="${GITHUB_SHA}"

      - name: Smoke test (basic)
        run: |
          set -euo pipefail
          echo "Waiting briefly for DNS/targets..."
          sleep 20

          echo "Smoke: API health"
          for i in {1..20}; do
            if curl -fsS "https://${CFN_API_DOMAIN_NAME}/api/v1/health" >/dev/null; then
              echo "API OK"
              break
            fi
            echo "Retry API health ($i)..."
            sleep 10
          done

          echo "Smoke: Landing healthz"
          for i in {1..20}; do
            if curl -fsS "https://${CFN_ROOT_DOMAIN_NAME}/healthz" >/dev/null; then
              echo "Landing OK"
              break
            fi
            echo "Retry landing healthz ($i)..."
            sleep 10
          done
