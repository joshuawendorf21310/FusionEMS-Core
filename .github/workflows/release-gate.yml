name: Release Gate

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["verdent-upgrades"]
  workflow_dispatch:
    inputs:
      stage:
        description: "Stage (dev/stage/prod)"
        required: false
        default: "stage"
      run_id:
        description: "Founder Copilot run_id (UUID)"
        required: false
        default: ""

jobs:
  release-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: quantumems_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@localhost:5432/quantumems_test
      STAGE: ${{ inputs.stage || 'stage' }}
      LOG_LEVEL: info
      OPENAI_API_KEY: ci_dummy
      STRIPE_SECRET_KEY: ci_dummy
      TELNYX_API_KEY: ci_dummy
      LOB_API_KEY: ci_dummy
      S3_BUCKET_DOCS: ci_dummy_bucket
      S3_BUCKET_EXPORTS: ci_dummy_bucket_exports
      SYSTEM_TENANT_ID: "00000000-0000-0000-0000-000000000000"
      JWT_SECRET_KEY: ci_dummy_jwt_key_32chars_minimum00
      AUTH_MODE: local
      ENVIRONMENT: development

    steps:
      - uses: actions/checkout@v4

      - name: Create reports directory
        run: mkdir -p reports

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install backend deps + tooling
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install ruff pytest

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      # ============================
      # BACKEND LINT
      # ============================
      - name: Ruff — runtime error gate
        id: ruff_gate
        run: |
          ruff check backend --select F821,E9,F63,F7,F82 \
            --exclude backend/versions/ \
            2>&1 | tee reports/ruff_gate.txt

      - name: Ruff — full lint
        id: ruff_full
        run: |
          ruff check backend \
            --exclude backend/versions/ \
            2>&1 | tee reports/ruff_full.txt || true

      # ============================
      # BACKEND TESTS
      # ============================
      - name: pytest
        id: pytest
        run: |
          set -e
          pytest -q --tb=short 2>&1 | tee reports/pytest.txt

      # ============================
      # DATABASE MIGRATIONS
      # ============================
      - name: Alembic upgrade head
        id: alembic
        run: |
          cd backend
          export DATABASE_URL="${DATABASE_URL}"
          alembic upgrade head

      # ============================
      # FRONTEND
      # ============================
      - name: Install frontend deps
        run: cd frontend && npm ci

      - name: Frontend typecheck
        id: tsc
        run: cd frontend && npm run typecheck 2>&1 | tee ../reports/tsc.txt

      - name: Frontend build
        id: next_build
        run: cd frontend && npm run build 2>&1 | tee ../reports/next_build.txt

      # ============================
      # CLOUDFORMATION
      # ============================
      - name: Install cfn-lint
        run: pip install cfn-lint

      - name: cfn-lint (errors only)
        id: cfn_lint
        run: |
          cfn-lint infra/cloudformation/*.yml \
            2>&1 | tee reports/cfn_lint.txt
          if grep -q "^E" reports/cfn_lint.txt; then
            echo "cfn-lint errors found"
            exit 1
          fi

      - name: Duplicate CFN logical ID scan
        id: cfn_duplicates
        run: python scripts/scan_cfn_duplicates.py 2>&1 | tee reports/cfn_duplicates.txt

      - name: Validate CFN templates
        id: cfn_validate
        run: python scripts/validate_cfn_templates.py 2>&1 | tee reports/cfn_validate.txt

      # ============================
      # SECURITY / CONFIG
      # ============================
      - name: Placeholder secrets scan
        id: placeholder_scan
        run: python scripts/scan_placeholders.py 2>&1 | tee reports/placeholder_scan.txt

      - name: Env var coverage scan
        id: env_coverage
        run: python scripts/scan_env_coverage.py 2>&1 | tee reports/env_coverage.txt

      - name: Route matrix gate
        id: route_matrix_gate
        run: python scripts/ci_gate_route_matrix.py 2>&1 | tee reports/route_matrix_gate.txt

      # ============================
      # REPORT ARTIFACTS
      # ============================
      - name: Upload release gate reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-gate-reports-${{ github.run_id }}
          path: reports/
          retention-days: 30
