name: Release Gate

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["verdent-upgrades"]
  workflow_dispatch:
    inputs:
      stage:
        description: "Stage (dev/stage/prod)"
        required: false
        default: "stage"
      run_id:
        description: "Founder Copilot run_id (UUID) — set by dashboard execution"
        required: false
        default: ""

jobs:
  release-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: quantumems_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@localhost:5432/quantumems_test
      STAGE: ${{ inputs.stage || 'stage' }}
      LOG_LEVEL: info
      OPENAI_API_KEY: ci_dummy
      STRIPE_SECRET_KEY: ci_dummy
      TELNYX_API_KEY: ci_dummy
      LOB_API_KEY: ci_dummy
      S3_BUCKET_DOCS: ci_dummy_bucket
      S3_BUCKET_EXPORTS: ci_dummy_bucket_exports
      SYSTEM_TENANT_ID: "00000000-0000-0000-0000-000000000000"
      JWT_SECRET_KEY: ci_dummy_jwt_key_32chars_minimum00
      AUTH_MODE: local
      ENVIRONMENT: development

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      # ── Backend: deps ──────────────────────────────────────────────────────
      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      # ── Backend: lint ──────────────────────────────────────────────────────
      - name: Ruff — runtime error gate (F821 + E9 + F63 + F7 + F82)
        id: ruff_gate
        run: |
          ruff check backend --select F821,E9,F63,F7,F82 --exclude backend/versions/

      - name: Ruff — full lint
        id: ruff_full
        run: |
          ruff check backend --exclude backend/versions/ || true

      # ── Backend: tests ─────────────────────────────────────────────────────
      - name: pytest
        id: pytest
        run: |
          pytest -q --tb=short 2>&1 | tee reports/pytest.txt || true
          # Fail if pytest itself failed
          pytest -q --tb=line

      # ── Database: Alembic migrations ───────────────────────────────────────
      - name: Alembic upgrade head
        id: alembic
        run: |
          cd backend
          alembic upgrade head

      # ── Frontend: deps ─────────────────────────────────────────────────────
      - name: Install frontend deps
        run: |
          cd frontend && npm ci

      - name: Frontend typecheck (tsc --noEmit)
        id: tsc
        run: |
          cd frontend && npm run typecheck 2>&1 | tee ../reports/tsc.txt

      - name: Frontend build
        id: next_build
        run: |
          cd frontend && npm run build 2>&1 | tee ../reports/next_build.txt

      # ── CloudFormation: lint + duplicate scan + validate ───────────────────
      - name: Install cfn-lint
        run: pip install cfn-lint

      - name: cfn-lint (errors only)
        id: cfn_lint
        run: |
          mkdir -p reports
          cfn-lint infra/cloudformation/*.yml 2>&1 | tee reports/cfn_lint.txt
          # Fail on E-class errors
          if grep -q "^E" reports/cfn_lint.txt; then
            echo "cfn-lint errors found"; exit 1
          fi

      - name: Duplicate CFN logical ID scan
        id: cfn_duplicates
        run: python scripts/scan_cfn_duplicates.py 2>&1 | tee reports/cfn_duplicates.txt

      - name: Validate CFN templates (static)
        id: cfn_validate
        run: python scripts/validate_cfn_templates.py 2>&1 | tee reports/cfn_validate.txt

      # ── Security / config hygiene ──────────────────────────────────────────
      - name: Placeholder secrets scan
        id: placeholder_scan
        run: python scripts/scan_placeholders.py 2>&1 | tee reports/placeholder_scan.txt

      - name: Env var coverage scan
        id: env_coverage
        run: python scripts/scan_env_coverage.py 2>&1 | tee reports/env_coverage.txt

      # ── Report back to Founder Copilot (if triggered from dashboard) ───────
      - name: Post gate results to Founder Copilot
        if: ${{ inputs.run_id != '' }}
        env:
          GATE_TOKEN: ${{ secrets.INTERNAL_WORKER_SECRET }}
          API_BASE: ${{ secrets.API_BASE_URL || 'https://api.fusionemsquantum.com' }}
          COPILOT_RUN_ID: ${{ inputs.run_id }}
        run: |
          RESULTS=$(python - <<'PYEOF'
          import json, os
          steps = {
              "ruff_gate": "${{ steps.ruff_gate.outcome }}",
              "pytest": "${{ steps.pytest.outcome }}",
              "alembic": "${{ steps.alembic.outcome }}",
              "tsc": "${{ steps.tsc.outcome }}",
              "next_build": "${{ steps.next_build.outcome }}",
              "cfn_lint": "${{ steps.cfn_lint.outcome }}",
              "cfn_duplicates": "${{ steps.cfn_duplicates.outcome }}",
              "cfn_validate": "${{ steps.cfn_validate.outcome }}",
              "placeholder_scan": "${{ steps.placeholder_scan.outcome }}",
              "env_coverage": "${{ steps.env_coverage.outcome }}",
          }
          results = {k: (v == "success") for k, v in steps.items()}
          print(json.dumps(results))
          PYEOF
          )
          curl -sf -X POST \
            "${API_BASE}/api/v1/founder/copilot/runs/${COPILOT_RUN_ID}/gate-result" \
            -H "Content-Type: application/json" \
            -H "X-Gate-Token: ${GATE_TOKEN}" \
            -d "{\"results\": ${RESULTS}, \"gh_run_id\": \"${{ github.run_id }}\", \"gh_run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
            || echo "gate-result post failed (non-fatal)"

      # ── Upload artifacts ────────────────────────────────────────────────────
      - name: Upload release gate reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-gate-reports-${{ github.run_id }}
          path: reports/
          retention-days: 30
