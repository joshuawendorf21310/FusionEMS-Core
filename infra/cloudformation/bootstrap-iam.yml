AWSTemplateFormatVersion: '2010-09-09'
Description: FusionEMS Quantum - Bootstrap IAM Stack (GitHub Deploy Role)

Parameters:
  GitHubOrg:
    Type: String

  GitHubRepo:
    Type: String
    Default: FusionEMS-Core

  RoleName:
    Type: String
    Default: FusionEMSQuantum-GitHubDeployRole

  ArtifactsBucket:
    Type: String
    Default: fusionemsquantum-cfn-artifacts-prod

Resources:

# ================= GITHUB DEPLOY ROLE =================

  GitHubActionsDeployRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref RoleName
      MaxSessionDuration: 3600
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Sub arn:aws:iam::${AWS::AccountId}:oidc-provider/token.actions.githubusercontent.com
            Action:
              - sts:AssumeRoleWithWebIdentity
              - sts:TagSession
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              StringLike:
                token.actions.githubusercontent.com:sub:
                  - !Sub 'repo:${GitHubOrg}/${GitHubRepo}:ref:refs/heads/main'
                  - !Sub 'repo:${GitHubOrg}/${GitHubRepo}:ref:refs/heads/prod'
                  - !Sub 'repo:${GitHubOrg}/${GitHubRepo}:ref:refs/tags/*'

      ManagedPolicyArns:
        # Founder production mode â€” full admin
        - arn:aws:iam::aws:policy/AdministratorAccess

# ================= ARTIFACT BUCKET =================

  ArtifactsBucketResource:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Ref ArtifactsBucket
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true

  ArtifactsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ArtifactsBucketResource
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: EnforceTLS
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !Sub 'arn:aws:s3:::${ArtifactsBucket}'
              - !Sub 'arn:aws:s3:::${ArtifactsBucket}/*'
            Condition:
              Bool:
                aws:SecureTransport: false

Outputs:
  DeployRoleArn:
    Value: !GetAtt GitHubActionsDeployRole.Arn
    Description: Set as AWS_ROLE_TO_ASSUME in GitHub Secrets

  ArtifactsBucketName:
    Value: !Ref ArtifactsBucketResource
