AWSTemplateFormatVersion: '2010-09-09'
Description: FusionEMS Quantum - Root Nested Stack (Enterprise Production-Ready)

Parameters:
  Env:
    Type: String
    AllowedValues: [dev, prod]
    Default: dev

  AppName:
    Type: String
    Default: fusionems-quantum

  RootDomainName:
    Type: String
    Default: fusionemsquantum.com

  ApiDomainName:
    Type: String
    Default: api.fusionemsquantum.com

  HostedZoneId:
    Type: String
    Description: Route53 Hosted Zone ID

  AcmCertificateArnUsEast1:
    Type: String
    Description: ACM certificate ARN in us-east-1 (for CloudFront)

  AcmCertificateArnRegional:
    Type: String
    Description: ACM certificate ARN in deployment region (for ALB)

  ImageTag:
    Type: String
    Default: latest

  DesiredCount:
    Type: Number
    Default: 2

  DbInstanceClass:
    Type: String
    Default: db.t4g.medium

  DbMultiAZ:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']

  RedisNodeType:
    Type: String
    Default: cache.t4g.small

  AlertEmail:
    Type: String
    Default: founder@fusionemsquantum.com

  SesFromEmail:
    Type: String
    Default: noreply@fusionemsquantum.com

  GitHubOrg:
    Type: String
    Description: GitHub organization or username (for OIDC trust policy)
    Default: ''

  GitHubRepo:
    Type: String
    Description: GitHub repository name (for OIDC trust policy)
    Default: FusionEMS-Core

  NestedTemplatesBucket:
    Type: String
    Description: S3 bucket where packaged nested templates are stored

Conditions:
  HasGitHubOrg: !Not [!Equals [!Ref GitHubOrg, '']]

Resources:

  NetworkStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: network.yml
      Parameters:
        Env: !Ref Env
        AppName: !Ref AppName
      Tags:
        - Key: Environment
          Value: !Ref Env
        - Key: Application
          Value: !Ref AppName

  DataStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: NetworkStack
    Properties:
      TemplateURL: data.yml
      Parameters:
        Env: !Ref Env
        AppName: !Ref AppName
        DbInstanceClass: !Ref DbInstanceClass
        DbMultiAZ: !Ref DbMultiAZ
        RedisNodeType: !Ref RedisNodeType
        VpcId: !GetAtt NetworkStack.Outputs.VpcId
        PrivateSubnets: !GetAtt NetworkStack.Outputs.PrivateSubnets
        EcsServiceSecurityGroupId: !GetAtt NetworkStack.Outputs.EcsServiceSecurityGroupId
      Tags:
        - Key: Environment
          Value: !Ref Env
        - Key: Application
          Value: !Ref AppName

  CognitoStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: NetworkStack
    Properties:
      TemplateURL: cognito.yml
      Parameters:
        Env: !Ref Env
        AppName: !Ref AppName
        RootDomainName: !Ref RootDomainName
      Tags:
        - Key: Environment
          Value: !Ref Env
        - Key: Application
          Value: !Ref AppName

  S3Stack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: s3.yml
      Parameters:
        Env: !Ref Env
        AppName: !Ref AppName
      Tags:
        - Key: Environment
          Value: !Ref Env

  WafStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: waf.yml
      Parameters:
        Env: !Ref Env
        AppName: !Ref AppName
      Tags:
        - Key: Environment
          Value: !Ref Env

  SesStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ses.yml
      Parameters:
        Env: !Ref Env
        AppName: !Ref AppName
        FromEmail: !Ref SesFromEmail
        RootDomainName: !Ref RootDomainName
      Tags:
        - Key: Environment
          Value: !Ref Env

  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${AppName}-${Env}-alerts'
      DisplayName: !Sub 'FusionEMS ${Env} Alerts'

  AlertTopicSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: !Ref AlertTopic
      Protocol: email
      Endpoint: !Ref AlertEmail

  ComputeStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - DataStack
      - CognitoStack
      - S3Stack
      - WafStack
    Properties:
      TemplateURL: compute.yml
      Parameters:
        Env: !Ref Env
        AppName: !Ref AppName
        VpcId: !GetAtt NetworkStack.Outputs.VpcId
        PublicSubnets: !GetAtt NetworkStack.Outputs.PublicSubnets
        PrivateSubnets: !GetAtt NetworkStack.Outputs.PrivateSubnets
        AlbSecurityGroupId: !GetAtt NetworkStack.Outputs.AlbSecurityGroupId
        EcsServiceSecurityGroupId: !GetAtt NetworkStack.Outputs.EcsServiceSecurityGroupId
        ImageTag: !Ref ImageTag
        DesiredCount: !Ref DesiredCount
        DbSecretArn: !GetAtt DataStack.Outputs.DbSecretArn
        AppSecretsArn: !GetAtt DataStack.Outputs.AppSecretsArn
        RedisPrimaryEndpoint: !GetAtt DataStack.Outputs.RedisPrimaryEndpoint
        CognitoUserPoolId: !GetAtt CognitoStack.Outputs.UserPoolId
        CognitoClientId: !GetAtt CognitoStack.Outputs.UserPoolClientId
        AcmCertificateArn: !Ref AcmCertificateArnRegional
        DbInstanceId: !GetAtt DataStack.Outputs.DbInstanceId
        RedisClusterId: !GetAtt DataStack.Outputs.RedisReplicationGroupId
        AlertTopicArn: !Ref AlertTopic
      Tags:
        - Key: Environment
          Value: !Ref Env
        - Key: Application
          Value: !Ref AppName

  WafAlbAssociation:
    Type: AWS::WAFv2::WebACLAssociation
    DependsOn:
      - WafStack
      - ComputeStack
    Properties:
      ResourceArn: !GetAtt ComputeStack.Outputs.AlbArn
      WebACLArn: !GetAtt WafStack.Outputs.WebAclArn

  EdgeStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: ComputeStack
    Properties:
      TemplateURL: edge.yml
      Parameters:
        Env: !Ref Env
        AppName: !Ref AppName
        RootDomainName: !Ref RootDomainName
        ApiDomainName: !Ref ApiDomainName
        HostedZoneId: !Ref HostedZoneId
        AcmCertificateArnUsEast1: !Ref AcmCertificateArnUsEast1
        AlbDnsName: !GetAtt ComputeStack.Outputs.AlbDnsName
      Tags:
        - Key: Environment
          Value: !Ref Env
        - Key: Application
          Value: !Ref AppName

  ObservabilityStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: ComputeStack
    Properties:
      TemplateURL: observability.yml
      Parameters:
        Env: !Ref Env
        AppName: !Ref AppName
        AlertEmail: !Ref AlertEmail
        AlertTopicArn: !Ref AlertTopic
        EcsClusterName: !GetAtt ComputeStack.Outputs.ClusterName
        BackendServiceName: !GetAtt ComputeStack.Outputs.BackendServiceName
        FrontendServiceName: !GetAtt ComputeStack.Outputs.FrontendServiceName
        AlbFullName: !GetAtt ComputeStack.Outputs.AlbFullName
        BackendTargetGroupFullName: !GetAtt ComputeStack.Outputs.BackendTargetGroupFullName
        DbInstanceId: !GetAtt DataStack.Outputs.DbInstanceId
        RedisClusterId: !GetAtt DataStack.Outputs.RedisReplicationGroupId
        RootDomainName: !Ref RootDomainName
        ApiDomainName: !Ref ApiDomainName
      Tags:
        - Key: Environment
          Value: !Ref Env
        - Key: Application
          Value: !Ref AppName

Outputs:
  RootDomainName:
    Value: !Ref RootDomainName

  ApiDomainName:
    Value: !Ref ApiDomainName

  CloudFrontDomain:
    Value: !GetAtt EdgeStack.Outputs.CloudFrontDomain

  BackendEcrRepoUri:
    Value: !GetAtt ComputeStack.Outputs.BackendEcrRepoUri

  FrontendEcrRepoUri:
    Value: !GetAtt ComputeStack.Outputs.FrontendEcrRepoUri

  CognitoUserPoolId:
    Value: !GetAtt CognitoStack.Outputs.UserPoolId

  CognitoUserPoolClientId:
    Value: !GetAtt CognitoStack.Outputs.UserPoolClientId

  AlertTopicArn:
    Value: !Ref AlertTopic
